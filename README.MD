# üßÆ The Demonized Orb Optimizer

A command-line optimizer for calculating the **best possible orb loadouts** in *The Demonized*.

Supports multiple solver strategies ‚Äî including a **beam search optimizer** for maximum precision and a **greedy optimizer** for fast, approximate results.

---

## üöÄ Setup

### 1Ô∏è‚É£ Install Python 3.11

> Python 3.11.x is required.

Download from [python.org](https://www.python.org/downloads/release/python-3119/).

### 2Ô∏è‚É£ Install `uv`

Install [Astral‚Äôs `uv`](https://github.com/astral-sh/uv), a modern, fast package manager:

```bash
# macOS (Homebrew)
brew install uv

# or via Astral‚Äôs official installer
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### 3Ô∏è‚É£ Install dependencies

```bash
make install
```

This will:

* Create a `.venv` virtual environment  
* Install runtime + dev dependencies (`uv sync --group dev`)  
* Prepare the CLI (`orb-optimize`) for immediate use  

For a production-only setup (no linting/testing tools):

```bash
make install-prod
```

---

## üß± Makefile Commands

| Command | Description |
|----------|-------------|
| `make install` | Create `.venv` and install all dependencies (`uv sync --group dev`) |
| `make install-prod` | Create `.venv` and install runtime-only dependencies |
| `make run` | Run the optimizer CLI (pass args via `ARGS="..."`) |
| `make lint` | Run Ruff linter |
| `make typecheck` | Run MyPy static type checks |
| `make format` | Run Black code formatter |
| `make test` | Run Pytest suite |
| `make clean` | Remove the virtual environment and build caches |

---

## ‚öôÔ∏è CLI Overview

The Orb Optimizer CLI supports **multiple solver strategies**, each as a dedicated subcommand:

| Command | Description |
|----------|-------------|
| `uv run orb-optimize ... optimize` | Runs the **Beam Search** solver (precision-focused) |
| `uv run orb-optimize ... greedy` | Runs the **Greedy** solver (fast heuristic-based) |

üìù *All global input options (like `--orbs`, `--slots`, `--profiles`) must come **before** the solver name.*

---

## üìÇ Input Files & Defaults

The optimizer requires orb and slot data, and can optionally load custom weighting and configuration files.  
If optional files are missing, **built-in defaults** are used automatically.

| File | Required | CLI Option | Description | Fallback Behavior |
|------|-----------|-------------|--------------|--------------------|
| `orbs.json` | ‚úÖ Yes | `--orbs` | List of orb definitions (`type`, `set`, `rarity`, `value`, `level`, etc.) | Must exist. |
| `slots.json` | ‚úÖ Yes | `--slots` | Defines category names and slot counts per rarity. | Must exist. |
| `set_priority.json` | ‚ùå Optional | `--set-priority` | Maps orb sets ‚Üí priority weights. | Uses `DEFAULT_SET_PRIORITY_WEIGHTS`. |
| `orb_weights.json` | ‚ùå Optional | `--orb-weights` | Maps orb type ‚Üí weighting multiplier. | Uses `DEFAULT_ORB_TYPE_WEIGHTS`. |
| `orb_level_weights.json` | ‚ùå Optional | `--orb-level-weights` | Orb type ‚Üí additive bonus per tier (3/6/9). | Uses `DEFAULT_ORB_LEVEL_WEIGHTS`. |
| `profiles.json` | ‚ùå Optional | `--profiles` | Defines multiple optimization profiles with weights and parameters. | If omitted, a single ‚Äúdefault‚Äù profile is synthesized. |

---

## üß† Example Usage

### üåÄ Run the Beam (Precise) Optimizer

```bash
uv run orb-optimize \
  --profiles ./data/profiles.json \
  --orbs ./data/orbs.json \
  --slots ./data/slots.json \
  beam \
  --beam 200 \
  --topk 20 \
  --refine-passes 2 \
  --refine-report

```

### ‚ö° Run the Greedy (Fast) Optimizer

```bash
uv run orb-optimize \
  --profiles ./data/profiles.json \
  --orbs ./data/orbs.json \
  --slots ./data/slots.json \
  greedy 
```

Greedy mode is significantly faster and suitable for experimentation or large datasets.

---

## üë• Multi-Profile Optimization (`profiles.json`)

You can run multiple weighted optimization profiles simultaneously.  
Each profile defines its own scoring weights, objective preference, and power coefficients.

Example:

```json
{
  "profiles": [
    {
      "name": "PVP",
      "objective": "types-first",
      "power": 2.0,
      "epsilon": 0.02,
      "weight": 1.0,
      "set_priority": "data/set_priority_dps.json",
      "orb_weights": "data/orb_weights_dps.json",
      "orb_level_weights": "data/orb_level_weights_dps.json"
    },
    {
      "name": "PVE",
      "objective": "sets-first",
      "power": 2.5,
      "epsilon": 0.01,
      "weight": 0.8,
      "set_priority": "data/set_priority_clearspeed.json",
      "orb_weights": "data/orb_weights_clearspeed.json",
      "orb_level_weights": "data/orb_level_weights_clearspeed.json"
    }
  ],
  "shareable_categories": [
    "Wings",
    "Wagon",
    "Beast"
  ]
}
```

**Explanation:**
- Each entry in `"profiles"` defines a full scoring profile.  
- The `"weight"` field determines its contribution to the combined score.  
- `"objective"` determines whether **set completion** or **orb quality** is prioritized.  
- `"shareable_categories"` lists categories that all profiles share the same orbs for (e.g., shared inventory).

You can reference other JSON weight files, or omit them to use defaults.

---

## üß∞ Development Tools

Installed automatically with `make install`:

* üßπ **Ruff** ‚Äî Linting and style enforcement  
* üß† **MyPy** ‚Äî Type checking  
* ‚öôÔ∏è **Black** ‚Äî Code formatting  
* üß™ **Pytest** ‚Äî Unit testing  

Run checks manually:

```bash
make lint
make typecheck
make format
make test
```

---

## üßæ License

MIT License ¬© 2025  
The Demonized Orb Optimizer project is open-source and community maintained.
